generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["boublenza"]
}

model Product {
  id         String             @id @default(cuid())
  name       String
  category   String
  unit       String             @default("kg")
  pricePerKg Float
  orders     OrderLine[]
  production ProductionEntry[]
  stock      StockEntry[]
  targets    ProductionTarget[]
  costs      ProductCost[]

  @@schema("boublenza")
}

model Client {
  id      String  @id @default(cuid())
  name    String
  country String
  city    String?
  email   String?
  phone   String?
  orders  Order[]
  trades  Trade[]
  leads   Lead[]

  @@schema("boublenza")
}

model Order {
  id           String      @id @default(cuid())
  clientId     String
  client       Client      @relation(fields: [clientId], references: [id])
  status       String
  totalAmount  Float
  currency     String      @default("USD")
  createdAt    DateTime    @default(now())
  deliveryDate DateTime?
  lines        OrderLine[]
  payments     Payment[]

  @@schema("boublenza")
}

model OrderLine {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Float
  unitPrice Float

  @@schema("boublenza")
}

model ProductionEntry {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Float
  date      DateTime
  shift     String?
  quality   String?

  @@schema("boublenza")
}

model StockEntry {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Float
  type      String
  reason    String?
  date      DateTime @default(now())

  @@schema("boublenza")
}

model Reseller {
  id              String    @id @default(cuid())
  name            String
  country         String
  type            String    @default("distributeur")
  status          String    @default("actif")
  since           DateTime
  contactName     String    @default("")
  totalRevenue    Float     @default(0)
  totalOrders     Int       @default(0)
  avgOrderValue   Float     @default(0)
  lastOrderDate   DateTime?
  growthRate      Float     @default(0)
  paymentScore    Int       @default(80)
  productsHandled String    @default("")
  target          Float     @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@schema("boublenza")
}

// ── Financial Tracking ────────────────────────────────

model Expense {
  id        String   @id @default(cuid())
  category  String   // raw_material, labor, energy, packaging, transport, rent, maintenance, other
  label     String
  amount    Float
  date      DateTime
  recurring Boolean  @default(false)

  @@schema("boublenza")
}

model Payment {
  id            String   @id @default(cuid())
  orderId       String
  order         Order    @relation(fields: [orderId], references: [id])
  amount        Float
  method        String   @default("wire_transfer") // wire_transfer, check, lc
  status        String   @default("pending") // pending, received, overdue, partial
  dueDate       DateTime
  receivedDate  DateTime?
  createdAt     DateTime @default(now())

  @@schema("boublenza")
}

model Budget {
  id       String @id @default(cuid())
  category String // revenue, cogs, opex, capex
  label    String
  month    Int
  year     Int
  amount   Float

  @@unique([category, label, month, year])
  @@schema("boublenza")
}

model ProductionTarget {
  id        String @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])
  month     Int
  year      Int
  quantity  Float
  capacity  Float  @default(40000)

  @@unique([productId, month, year])
  @@schema("boublenza")
}

model ProductCost {
  id              String  @id @default(cuid())
  productId       String
  product         Product @relation(fields: [productId], references: [id])
  rawMaterialCost Float   // per kg
  laborCost       Float   // per kg
  energyCost      Float   // per kg
  packagingCost   Float   // per kg
  overheadCost    Float   // per kg
  effectiveDate   DateTime @default(now())

  @@schema("boublenza")
}

model CashEntry {
  id       String   @id @default(cuid())
  type     String   // inflow, outflow
  category String   // sales, expense, investment, loan, tax
  label    String
  amount   Float
  date     DateTime
  balance  Float    // running balance at this point

  @@schema("boublenza")
}

// ── Trading Desk ─────────────────────────────────────

model Trade {
  id              String    @id @default(cuid())
  tradeRef        String    @unique        // e.g. "TRD-2026-0001"
  counterpartyId  String
  counterparty    Client    @relation(fields: [counterpartyId], references: [id])
  instrument      String                   // "CARUMA", "CARANI", "CAROB EXTRACT", "COCOA_FUTURE", "FX_EURUSD"
  side            String                   // "buy" | "sell"
  quantity        Float                    // kg for physicals, lots for futures
  price           Float                    // trade price
  currency        String    @default("USD")
  tradeDate       DateTime
  settlementDate  DateTime?
  method          String    @default("physical") // physical, futures, swap, option
  status          String    @default("open")     // open, partially_filled, closed, settled, cancelled
  pnlRealized     Float     @default(0)
  pnlUnrealized   Float     @default(0)
  positions       TradingPosition[]
  attributions    PnLAttribution[]
  settlements     SettlementTransaction[]
  createdAt       DateTime  @default(now())

  @@schema("boublenza")
}

model TradingPosition {
  id            String   @id @default(cuid())
  tradeId       String
  trade         Trade    @relation(fields: [tradeId], references: [id])
  instrument    String
  side          String   // "long" | "short"
  quantity      Float
  avgPrice      Float    // average entry price
  markPrice     Float    // current market price (MTM)
  currency      String   @default("USD")
  unrealizedPnl Float    @default(0)
  realizedPnl   Float    @default(0)
  deltaExposure Float    @default(0)
  openDate      DateTime
  closeDate     DateTime?
  status        String   @default("open") // open, closed, rolled

  @@schema("boublenza")
}

model Derivative {
  id          String   @id @default(cuid())
  type        String   // call, put, swap, forward
  underlying  String   // "COCOA", "CAROB", "EURUSD"
  side        String   // "buy" | "sell"
  quantity    Float
  strike      Float?   // for options
  expiry      DateTime
  premium     Float    @default(0)
  notional    Float
  delta       Float    @default(0)
  gamma       Float    @default(0)
  vega        Float    @default(0)
  theta       Float    @default(0)
  rho         Float    @default(0)
  markToMarket Float   @default(0)
  status      String   @default("active") // active, expired, exercised, closed
  createdAt   DateTime @default(now())

  @@schema("boublenza")
}

model FuturesContract {
  id              String   @id @default(cuid())
  exchange        String   // ICE, LIFFE, CME
  symbol          String   // "CC" (cocoa), "SB" (sugar), "KC" (coffee)
  contractMonth   String   // "2026-03", "2026-06"
  underlying      String   // "COCOA", "SUGAR", "COFFEE"
  bid             Float
  ask             Float
  settlement      Float    // daily settlement price
  openInterest    Int      @default(0)
  volume          Int      @default(0)
  priorSettlement Float    @default(0)
  date            DateTime
  createdAt       DateTime @default(now())

  @@unique([symbol, contractMonth, date])
  @@schema("boublenza")
}

model MarketData {
  id         String   @id @default(cuid())
  source     String   // "FRED", "ICE", "FRANKFURTER", "INTERNAL"
  instrument String   // "COCOA_USD", "CAROB_USD", "SUGAR_USD", "EURUSD", etc.
  date       DateTime
  open       Float?
  high       Float?
  low        Float?
  close      Float    // closing price — required for VaR
  volume     Float?
  createdAt  DateTime @default(now())

  @@unique([instrument, date])
  @@index([instrument, date])
  @@schema("boublenza")
}

model TradingLimit {
  id             String  @id @default(cuid())
  entity         String  // "counterparty", "product", "desk", "trader"
  entityRef      String  // client ID, product name, or desk name
  riskType       String  // "notional", "var", "delta", "concentration"
  limitAmount    Float
  currentUsage   Float   @default(0)
  utilizationPct Float   @default(0)
  currency       String  @default("USD")
  breached       Boolean @default(false)
  lastUpdated    DateTime @default(now())

  @@unique([entity, entityRef, riskType])
  @@schema("boublenza")
}

model VaRBacktest {
  id             String   @id @default(cuid())
  date           DateTime
  method         String   // "historical", "parametric", "montecarlo"
  confidence     Float    // 0.95, 0.99
  horizon        Int      @default(1) // days
  varForecast    Float    // forecasted VaR
  realizedPnl    Float    // actual P&L that day
  breach         Boolean  // abs(realizedPnl) > varForecast
  portfolio      String   @default("total") // "total", "physical", "derivatives"

  @@unique([date, method, confidence, portfolio])
  @@schema("boublenza")
}

model PnLAttribution {
  id          String   @id @default(cuid())
  tradeId     String?
  trade       Trade?   @relation(fields: [tradeId], references: [id])
  date        DateTime
  portfolio   String   @default("total")
  marketMove  Float    @default(0) // delta × ΔS
  carry       Float    @default(0) // time decay / storage cost
  spread      Float    @default(0) // bid-ask capture
  theta       Float    @default(0) // options time decay
  vega        Float    @default(0) // vol change
  gamma       Float    @default(0) // convexity
  fx          Float    @default(0) // FX component
  other       Float    @default(0) // residual
  total       Float    @default(0) // sum of all components

  @@schema("boublenza")
}

model SettlementTransaction {
  id        String   @id @default(cuid())
  tradeId   String
  trade     Trade    @relation(fields: [tradeId], references: [id])
  date      DateTime
  amount    Float
  currency  String   @default("USD")
  method    String   @default("wire_transfer") // wire_transfer, lc, clearing_house
  status    String   @default("pending") // pending, confirmed, settled, failed
  reference String?

  @@schema("boublenza")
}

model QualityTest {
  id                String   @id @default(cuid())
  productionEntryId String?
  product           String   // "CARUMA", "CARANI", "CAROB EXTRACT"
  lotNumber         String
  testType          String   // "moisture", "particle_size", "color", "purity", "microbiological"
  spec              String   // target specification (e.g. "< 8%")
  actual            String   // measured value (e.g. "6.2%")
  numericActual     Float?   // numeric value for analytics
  result            String   // "pass", "fail", "marginal"
  testDate          DateTime
  certifiedBy       String?

  @@index([product, testDate])
  @@schema("boublenza")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String   @default("system")
  action    String   // "create", "update", "delete", "login", "export", "approve"
  entity    String   // "trade", "order", "position", "settlement", etc.
  entityId  String?
  details   String?  // JSON string with change details
  ipAddress String?
  timestamp DateTime @default(now())

  @@index([entity, timestamp])
  @@schema("boublenza")
}

// ── Sales CRM ───────────────────────────────────────

model SalesRep {
  id          String          @id @default(cuid())
  name        String
  email       String          @unique
  role        String          // "Senior Commercial" | "Junior Commercial"
  territory   String          // "Europe & Middle East" | "North Africa & Americas"
  quota       Float           // Annual target in USD
  avatar      String?
  phone       String?
  deals       Deal[]
  leads       Lead[]
  activities  Activity[]
  googleToken GoogleToken?
  forecasts   SalesForecast[]
  createdAt   DateTime        @default(now())

  @@schema("boublenza")
}

model Lead {
  id           String     @id @default(cuid())
  company      String
  contactName  String
  contactEmail String
  contactPhone String?
  source       String     // "website" | "referral" | "linkedin" | "trade_show"
  status       String     @default("new") // "new" | "contacted" | "qualified" | "converted" | "lost"
  notes        String?
  repId        String
  rep          SalesRep   @relation(fields: [repId], references: [id])
  clientId     String?
  client       Client?    @relation(fields: [clientId], references: [id])
  deals        Deal[]
  activities   Activity[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@schema("boublenza")
}

model Deal {
  id            String     @id @default(cuid())
  title         String
  value         Float      // Amount in USD
  currency      String     @default("USD")
  stage         String     // prospection|qualification|proposition|negociation|closing|won|lost
  probability   Int        // 0-100
  product       String     // CARUMA|CARANI|CAROB_EXTRACT
  quantity      Float?     // tonnes
  repId         String
  rep           SalesRep   @relation(fields: [repId], references: [id])
  leadId        String?
  lead          Lead?      @relation(fields: [leadId], references: [id])
  expectedClose DateTime?
  closedAt      DateTime?
  notes         String?
  activities    Activity[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@schema("boublenza")
}

model Activity {
  id        String    @id @default(cuid())
  type      String    // "call" | "email" | "meeting" | "note" | "task"
  subject   String
  body      String?
  repId     String
  rep       SalesRep  @relation(fields: [repId], references: [id])
  leadId    String?
  lead      Lead?     @relation(fields: [leadId], references: [id])
  dealId    String?
  deal      Deal?     @relation(fields: [dealId], references: [id])
  dueDate   DateTime?
  completed Boolean   @default(false)
  createdAt DateTime  @default(now())

  @@schema("boublenza")
}

model GoogleToken {
  id           String   @id @default(cuid())
  repId        String   @unique
  rep          SalesRep @relation(fields: [repId], references: [id])
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  scopes       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@schema("boublenza")
}

model SalesForecast {
  id         String   @id @default(cuid())
  repId      String
  rep        SalesRep @relation(fields: [repId], references: [id])
  period     String   // "2025-Q1", "2025-Q2", etc.
  weighted   Float    // Sum(value × probability)
  bestCase   Float
  worstCase  Float
  aiAdjusted Float?
  createdAt  DateTime @default(now())

  @@schema("boublenza")
}
